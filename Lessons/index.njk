---
layout: layouts/base.njk
title: Home
permalink: /
---

<!-- Early BrowserSync Dialog Blocker -->
<script>
  (function() {
    // Override window.confirm ASAP before BrowserSync loads
    const originalConfirm = window.confirm;
    window.confirm = function(message) {
      console.log('[Early Blocker] Intercepted confirm:', message);
      // Auto-decline all confirm dialogs (acts like clicking Cancel)
      return false;
    };
    console.log('[Early Blocker] window.confirm overridden');
  })();
</script>

<div style="text-align: center; margin-bottom: 4rem; padding: 4rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 0 0 48px 48px; margin-top: -2rem; box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3); position: relative;">
  <!-- User Menu (Top Right) -->
  <div id="user-menu" style="position: absolute; top: 2rem; right: 2rem; display: flex; gap: 1rem; align-items: center;">
    <div id="logged-out-buttons" style="display: flex; gap: 0.75rem;">
      <button onclick="showLogin()" style="padding: 0.75rem 1.5rem; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); color: white; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
        Login
      </button>
      <button onclick="showRegister()" style="padding: 0.75rem 1.5rem; background: white; color: #667eea; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);">
        Sign Up
      </button>
    </div>
    <div id="logged-in-buttons" style="display: none; align-items: center; gap: 1rem;">
      <span id="username-display" style="color: white; font-weight: 600; font-size: 0.95rem;"></span>
      <button onclick="showProfile()" style="padding: 0.75rem 1.5rem; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); color: white; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
        Profile
      </button>
      <button onclick="logout()" style="padding: 0.75rem 1.5rem; background: rgba(255, 92, 92, 0.9); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
        Logout
      </button>
    </div>
  </div>

  <div style="max-width: 900px; margin: 0 auto;">
    <div style="display: inline-block; padding: 0.5rem 1.5rem; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border-radius: 20px; margin-bottom: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.2);">
      <span style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; font-weight: 600; letter-spacing: 0.05em;">AI-POWERED EDUCATION</span>
    </div>
    <h1 style="font-size: 4rem; margin-bottom: 1.5rem; color: white; font-weight: 900; letter-spacing: -0.03em; line-height: 1.1;">
      Intelligent Photocopier
    </h1>
    <p style="font-size: 1.4rem; color: rgba(255, 255, 255, 0.95); font-weight: 400; max-width: 700px; margin: 0 auto 2.5rem; line-height: 1.6;">
      Transform your educational content into professional, AI-enhanced programming courses with cutting-edge technology
    </p>
    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
      <a href="#courseBuilder" style="display: inline-block; padding: 1rem 2.5rem; background: white; color: #667eea; border-radius: 16px; font-weight: 700; text-decoration: none; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; font-size: 1.1rem;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 30px rgba(0, 0, 0, 0.2)'">
        Start Creating
      </a>
      <a href="#courses" style="display: inline-block; padding: 1rem 2.5rem; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); color: white; border-radius: 16px; font-weight: 700; text-decoration: none; border: 2px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; font-size: 1.1rem;" onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.borderColor='rgba(255, 255, 255, 0.5)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.borderColor='rgba(255, 255, 255, 0.3)'">
        Browse Courses
      </a>
    </div>
  </div>
</div>

<!-- AI Course Builder - Moved to Top -->
<div id="courseBuilder-section" style="margin-bottom: 4rem; padding: 4rem 3rem; background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); border-radius: 32px; box-shadow: 0 12px 40px rgba(142, 197, 252, 0.3);">
  <div style="text-align: center; margin-bottom: 3rem;">
    <div style="display: inline-block; padding: 0.5rem 1.5rem; background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255, 255, 255, 0.4);">
      <span style="color: #2d3748; font-size: 0.85rem; font-weight: 700; letter-spacing: 0.05em;">AI COURSE GENERATOR</span>
    </div>
    <h2 style="border: none; font-size: 2.75rem; margin-bottom: 1rem; font-weight: 800; color: #1a202c;">Create Your Course with AI</h2>
    <p style="font-size: 1.25rem; color: #2d3748; max-width: 600px; margin: 0 auto; line-height: 1.6;">
      Transform your ideas into professional programming courses instantly
    </p>
  </div>

  <div id="courseBuilder" style="background: white; padding: 3rem; border-radius: 28px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); scroll-margin-top: 2rem;">

    <!-- Step 1: Material Input (Direct Entry) -->
    <div class="builder-step active" id="step1">
      <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.5rem;">1</div>
        <h3 style="margin: 0; font-size: 1.75rem;">Provide Your Course Material</h3>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <button class="input-method-btn active" onclick="selectInputMethod('paste', this)" style="padding: 1.5rem; background: white; border: 3px solid #667eea; border-radius: 20px; cursor: pointer; transition: all 0.3s; font-weight: 600; font-size: 1rem;">
          üìù Paste Text
        </button>
        <button class="input-method-btn" onclick="selectInputMethod('upload', this)" style="padding: 1.5rem; background: white; border: 3px solid #e2e8f0; border-radius: 20px; cursor: pointer; transition: all 0.3s; font-weight: 600; font-size: 1rem;">
          üìÑ Upload File
        </button>
      </div>

      <!-- Paste Text Area -->
      <div id="pasteArea" class="input-area">
        <textarea id="courseContent" placeholder="Paste your course outline, learning objectives, or any reference material here...

Example:
# Course: Advanced Python Design Patterns
## Learning Objectives
- Master creational patterns (Singleton, Factory, Builder)
- Implement structural patterns (Adapter, Decorator, Facade)
- Apply behavioral patterns (Observer, Strategy, Command)
- Write SOLID, maintainable code

## Topics to Cover
1. Introduction to Design Patterns
2. Creational Patterns with Examples
3. Structural Patterns in Practice
4. Behavioral Patterns for Clean Code
5. Real-world Applications" style="width: 100%; min-height: 300px; padding: 1.5rem; border: 2px solid #e2e8f0; border-radius: 16px; font-family: 'Fira Code', monospace; font-size: 0.95rem; resize: vertical;"></textarea>
      </div>

      <!-- Upload Area -->
      <div id="uploadArea" class="input-area" style="display: none;">
        <div style="border: 3px dashed #cbd5e0; border-radius: 20px; padding: 3rem; text-align: center; background: #f7fafc; cursor: pointer;" onclick="document.getElementById('fileInput').click()">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
          <p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Drop files here or click to browse</p>
          <p style="color: #718096; font-size: 0.9rem;">Supports PDF, TXT, DOCX, MD</p>
          <input type="file" id="fileInput" accept=".pdf,.txt,.docx,.md" style="display: none;" onchange="handleFileUpload(event)">
        </div>
        <div id="filePreview" style="margin-top: 1.5rem; display: none;"></div>
      </div>

      <div id="step1Error" style="display: none; margin-top: 1.5rem; padding: 1rem; background: #fee; border-left: 4px solid #dc2626; border-radius: 8px; color: #dc2626; font-weight: 600;">
        ‚ö†Ô∏è Please provide course material in the text area before continuing.
      </div>

      <button class="btn" onclick="(function() {
        var content = document.getElementById('courseContent').value.trim();
        var errorDiv = document.getElementById('step1Error');
        if (!content) {
          errorDiv.style.display = 'block';
          errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          return;
        }
        errorDiv.style.display = 'none';
        document.querySelectorAll('.builder-step').forEach(function(s) {
          s.style.display = 'none';
        });
        var step2 = document.getElementById('step2');
        if (step2) {
          step2.style.display = 'block';
        }
      })()" style="margin-top: 2rem; width: 100%; font-size: 1.1rem; padding: 1.25rem;">
        Continue to Configuration ‚Üí
      </button>
    </div>

    <!-- Step 2: Course Configuration -->
    <div class="builder-step" id="step2" style="display: none;">
      <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.5rem;">2</div>
        <h3 style="margin: 0; font-size: 1.75rem;">Configure Your Course</h3>
      </div>

      <div style="display: grid; gap: 1.5rem;">
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2d3748;">Course ID <span style="color: #e53e3e;">*</span></label>
          <input type="text" id="courseId" placeholder="e.g., B3-advanced-design-patterns" style="width: 100%; padding: 1rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;">
          <p style="color: #718096; font-size: 0.85rem; margin-top: 0.5rem;">Format: [Letter][Number]-kebab-case (e.g., A1, B2, C3)</p>
        </div>

        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2d3748;">Course Title <span style="color: #e53e3e;">*</span></label>
          <input type="text" id="courseTitle" placeholder="e.g., Advanced Python Design Patterns" style="width: 100%; padding: 1rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2d3748;">Level <span style="color: #e53e3e;">*</span></label>
            <select id="courseLevel" style="width: 100%; padding: 1rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; background: white;">
              <option>Beginner</option>
              <option selected>Intermediate</option>
              <option>Advanced</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2d3748;">Duration <span style="color: #e53e3e;">*</span></label>
            <select id="courseDuration" style="width: 100%; padding: 1rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; background: white;">
              <option>1-2 hours</option>
              <option>2-3 hours</option>
              <option selected>3-4 hours</option>
              <option>4-5 hours</option>
              <option>5-6 hours</option>
              <option>Full day</option>
            </select>
          </div>
        </div>

        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2d3748;">Description</label>
          <textarea id="courseDescription" placeholder="Brief description of what students will learn..." style="width: 100%; min-height: 100px; padding: 1rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; resize: vertical;"></textarea>
        </div>

        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 1rem; color: #2d3748;">Course Structure (Select Files to Generate)</label>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; cursor: pointer;">
              <input type="checkbox" checked disabled> <strong>README.md</strong> <span style="color: #718096; font-size: 0.85rem;">(Required)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; cursor: pointer;">
              <input type="checkbox" id="incLessonContent" checked disabled> <strong>lesson-content.md</strong> <span style="color: #718096; font-size: 0.85rem;">(Required)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer;">
              <input type="checkbox" id="incSummary" checked> <strong>summary.md</strong>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer;">
              <input type="checkbox" id="incReference" checked> <strong>reference/</strong>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer;">
              <input type="checkbox" id="incSolutions" checked> <strong>solutions/</strong>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer;">
              <input type="checkbox" id="incTests" checked> <strong>tests/</strong>
            </label>
          </div>
          <p style="color: #718096; font-size: 0.85rem; margin-top: 1rem;">
            ‚ÑπÔ∏è Matches the structure: <code>Lessons/[CourseID]/[files]</code>
          </p>
        </div>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <button class="btn" onclick="prevStep(1)" style="flex: 1; background: #e2e8f0; color: #4a5568;">
          ‚Üê Back
        </button>
        <button class="btn" onclick="generateCourse()" style="flex: 2; font-size: 1.1rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); box-shadow: 0 4px 20px rgba(245, 87, 108, 0.4);">
          üöÄ Generate Course with AI
        </button>
      </div>
    </div>

    <!-- Step 3: Generation Progress -->
    <div class="builder-step" id="step3" style="display: none;">
      <div style="text-align: center; padding: 3rem 0;">
        <div class="loading-spinner" style="width: 80px; height: 80px; margin: 0 auto 2rem; border: 6px solid #e2e8f0; border-top: 6px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <h3 style="font-size: 2rem; margin-bottom: 1.5rem;">Generating Your Course...</h3>

        <!-- Progress Bar -->
        <div style="max-width: 500px; margin: 0 auto 2rem;">
          <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden; border: 2px solid #cbd5e0;">
            <div id="progressBar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.8s ease;"></div>
          </div>
          <p id="progressText" style="margin-top: 1rem; font-size: 1.2rem; font-weight: 700; color: #667eea;">Generating content with AI...</p>
          <p id="progressPercent" style="margin-top: 0.5rem; font-size: 1.1rem; font-weight: 600; color: #4a5568;">0%</p>
        </div>
      </div>
    </div>

    <!-- Step 4: Success & Preview -->
    <div class="builder-step" id="step4" style="display: none;">
      <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">‚úì</div>
        <h3 style="margin: 0; font-size: 1.75rem;">Course Generated Successfully!</h3>
      </div>

      <div id="outputPreview" style="background: #f7fafc; padding: 2rem; border-radius: 20px; margin-bottom: 2rem;">
        <div style="margin-bottom: 1.5rem;">
          <h4 style="font-size: 1.5rem; margin-bottom: 1rem;">üìã <span id="previewTitle">Your Course</span></h4>
          <div style="background: white; padding: 1.5rem; border-radius: 16px;" id="courseStructurePreview">
            <p style="margin: 0;"><strong>‚úì Course structure created</strong></p>
          </div>
        </div>
      </div>

      <div style="background: #fef3c7; padding: 1.5rem; border-radius: 16px; margin-bottom: 2rem;">
        <p style="margin: 0; font-weight: 600;">üìÅ Course Location:</p>
        <code style="background: white; padding: 0.5rem 1rem; border-radius: 8px; display: inline-block; margin-top: 0.5rem;" id="courseLocation">Lessons/[CourseID]/</code>
      </div>

      <div style="display: flex; gap: 1rem;">
        <button class="btn" onclick="resetBuilder()" style="flex: 1; background: #e2e8f0; color: #4a5568;">
          Create Another Course
        </button>
        <button class="btn" onclick="viewCourse()" style="flex: 2;">
          üëÄ View Generated Course
        </button>
      </div>
    </div>

  </div>
</div>

<style>
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .input-method-btn:hover {
    border-color: #667eea !important;
    transform: translateY(-2px);
  }

  .input-method-btn.active {
    border-color: #667eea !important;
    background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%) !important;
  }

  #courseContent:focus, input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    .builder-step {
      padding: 1.5rem !important;
    }

    .builder-step h3 {
      font-size: 1.3rem !important;
    }

    /* Step number badges smaller on mobile */
    .builder-step > div:first-child > div:first-child {
      width: 40px !important;
      height: 40px !important;
      font-size: 1.2rem !important;
    }

    /* Single column layout for input method buttons */
    #step1 > div:nth-child(2) {
      grid-template-columns: 1fr !important;
    }

    /* Stack form fields vertically on mobile */
    div[style*="grid-template-columns: 1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }

    /* Course structure checkboxes - single column */
    div[style*="display: grid; grid-template-columns: repeat(2, 1fr)"] {
      grid-template-columns: 1fr !important;
    }

    /* Reduce padding on form elements */
    input, select, textarea {
      padding: 0.8rem !important;
      font-size: 0.95rem !important;
    }

    /* Full width buttons on mobile */
    .btn {
      width: 100% !important;
      padding: 1rem !important;
      font-size: 1rem !important;
    }

    /* Review table responsive */
    table {
      font-size: 0.9rem !important;
    }

    table td {
      padding: 0.75rem !important;
    }
  }

  @media (max-width: 480px) {
    .builder-step {
      padding: 1rem !important;
      border-radius: 16px !important;
    }

    .builder-step h3 {
      font-size: 1.1rem !important;
    }

    /* Even smaller on very small screens */
    input, select, textarea {
      padding: 0.7rem !important;
      font-size: 0.9rem !important;
    }

    /* Compact labels */
    label {
      font-size: 0.9rem !important;
    }

    /* Reduce gaps */
    div[style*="gap: 1.5rem"] {
      gap: 1rem !important;
    }

    /* Compact course structure options */
    label[style*="padding: 1rem"] {
      padding: 0.75rem !important;
      font-size: 0.85rem !important;
    }

    /* Navigation buttons side by side but smaller */
    div[style*="display: flex; gap: 1rem; margin-top"] button {
      padding: 0.8rem 1rem !important;
      font-size: 0.9rem !important;
    }
  }
</style>

<script>
  let selectedInputMethod = 'paste';
  let generatedCourseId = '';

  // Intercept and block all window.confirm dialogs from BrowserSync
  const originalConfirm = window.confirm;
  window.confirm = function(message) {
    // If it's a BrowserSync reload prompt, automatically return false (Cancel)
    if (message && (message.includes('Reload') || message.includes('reload') || message.includes('saved'))) {
      console.log('[BrowserSync] Blocked confirm dialog:', message);
      return false;
    }
    return originalConfirm.apply(this, arguments);
  };

  // Prevent page reload during course generation
  window.addEventListener('beforeunload', function(e) {
    if (window.isGeneratingCourse) {
      console.log('[beforeunload] Preventing page unload during generation');
      e.preventDefault();
      e.returnValue = '';
      return '';
    }
  });

  // Disable BrowserSync notifications and prompts
  setTimeout(() => {
    if (window.___browserSync___) {
      console.log('[BrowserSync] Disabling all reload prompts and notifications');

      // Completely disable notify popups
      if (window.___browserSync___.notify) {
        window.___browserSync___.notify = function() {
          console.log('[BrowserSync] Notify disabled');
        };
      }

      // Override socket to block all reload events
      const originalEmit = window.___browserSync___.socket.emit;
      window.___browserSync___.socket.emit = function(event, data) {
        // Block all reload-related events
        if (event === 'browser:reload' || event === 'browser:notify' || event === 'file:reload') {
          console.log('[BrowserSync] Blocked reload event:', event);
          return;
        }
        return originalEmit.apply(this, arguments);
      };

      // Override reload function
      const originalReload = window.___browserSync___.reload;
      window.___browserSync___.reload = function() {
        console.log('[BrowserSync] Reload function disabled');
        return;
      };

      // Override the socket 'on' listener for browser:reload
      if (window.___browserSync___.socket && window.___browserSync___.socket.on) {
        const originalOn = window.___browserSync___.socket.on;
        window.___browserSync___.socket.on = function(event, callback) {
          if (event === 'browser:reload' || event === 'file:reload') {
            console.log('[BrowserSync] Blocked listener for:', event);
            return;
          }
          return originalOn.apply(this, arguments);
        };
      }

      // Intercept confirmReload if it exists
      if (window.___browserSync___.confirmReload) {
        window.___browserSync___.confirmReload = function() {
          console.log('[BrowserSync] confirmReload disabled');
          return false;
        };
      }
    }
  }, 100);

  function selectInputMethod(method, element) {
    selectedInputMethod = method;

    // Remove active class and reset border color for all buttons
    document.querySelectorAll('.input-method-btn').forEach(btn => {
      btn.classList.remove('active');
      btn.style.borderColor = '#e2e8f0';
    });

    // Add active class and set active border color for selected button
    element.classList.add('active');
    element.style.borderColor = '#667eea';

    // Toggle input areas
    document.querySelectorAll('.input-area').forEach(area => area.style.display = 'none');
    document.getElementById(method + 'Area').style.display = 'block';
  }

  function nextStep(step) {
    console.log(`[nextStep] Switching to step ${step}`);
    console.log(`[nextStep] Current URL: ${window.location.href}`);

    // Switch to the requested step
    document.querySelectorAll('.builder-step').forEach(s => s.style.display = 'none');
    const targetStep = document.getElementById('step' + step);

    if (targetStep) {
      targetStep.style.display = 'block';
      targetStep.classList.add('active');
      console.log(`[nextStep] Step ${step} is now visible`);
      document.getElementById('courseBuilder').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
      console.error(`[nextStep] Could not find step element: step${step}`);
    }
  }

  function prevStep(step) {
    nextStep(step);
  }

  function handleFileUpload(event) {
    const file = event.target.files[0];
    if (file) {
      const preview = document.getElementById('filePreview');
      preview.style.display = 'block';
      preview.innerHTML = `
        <div style="padding: 1.5rem; background: #d1fae5; border-radius: 16px; display: flex; align-items: center; gap: 1rem;">
          <span style="font-size: 2rem;">üìÑ</span>
          <div style="flex: 1;">
            <p style="margin: 0; font-weight: 600; color: #065f46;">${file.name}</p>
            <p style="margin: 0; color: #059669; font-size: 0.9rem;">${(file.size / 1024).toFixed(2)} KB</p>
          </div>
          <span style="color: #10b981; font-weight: 600; font-size: 1.5rem;">‚úì</span>
        </div>
      `;
    }
  }

  async function generateCourse() {
    console.log('[generateCourse] Function started');
    console.log('[generateCourse] Current URL:', window.location.href);

    // Get values
    const courseId = document.getElementById('courseId').value.trim();
    const courseTitle = document.getElementById('courseTitle').value.trim();
    const courseContent = document.getElementById('courseContent').value.trim();

    console.log(`[generateCourse] CourseID: ${courseId}, Title: ${courseTitle}`);

    // Only check if required fields exist
    if (!courseId || !courseTitle) {
      console.log('[generateCourse] Missing required fields');
      alert('‚ö†Ô∏è Please fill in Course ID and Title');
      return;
    }

    generatedCourseId = courseId;

    // Prepare API request
    const payload = {
      courseId: courseId,
      title: courseTitle,
      level: document.getElementById('courseLevel').value,
      duration: document.getElementById('courseDuration').value,
      description: document.getElementById('courseDescription').value.trim(),
      content: courseContent || 'Create a comprehensive programming course',
      sections: {
        summary: document.getElementById('incSummary').checked,
        reference: document.getElementById('incReference').checked,
        solutions: document.getElementById('incSolutions').checked,
        tests: document.getElementById('incTests').checked
      }
    };

    // Switch to step 3 and wait for DOM
    nextStep(3);
    await sleep(100);

    try {
      // Mark that we're generating to prevent page reload
      window.isGeneratingCourse = true;

      // Initialize progress bar
      console.log('Initializing progress bar...');
      updateProgressBar(0, 'Starting course generation...');
      await sleep(2000);

      // Progress: Analyzing
      console.log('Progress: 10%');
      updateProgressBar(10, 'Analyzing course material...');
      await sleep(3000);

      console.log('Progress: 20%');
      updateProgressBar(20, 'Preparing AI prompts...');
      await sleep(3000);

      // Progress: Generating - Start API call and simulate progress
      console.log('Progress: 30%');
      updateProgressBar(30, 'Generating content with AI...');
      await sleep(2000);

      // Call API in background while updating progress
      console.log('Calling API...');

      // Prepare headers with optional authentication
      const headers = {
        'Content-Type': 'application/json',
      };

      // Add auth token if user is logged in
      if (accessToken) {
        headers['Authorization'] = `Bearer ${accessToken}`;
        console.log('User authenticated - course will be saved to profile');
      }

      const apiPromise = fetch('https://intelligent-photocopier.onrender.com/api/generate-course', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(payload)
      });

      // Simulate progress during API call (spread over ~90 seconds)
      updateProgressBar(40, 'AI is writing lesson content...');
      await sleep(15000);  // 15 seconds
      updateProgressBar(50, 'Creating exercises and examples...');
      await sleep(15000);  // 15 seconds
      updateProgressBar(60, 'Generating reference materials...');
      await sleep(15000);  // 15 seconds
      updateProgressBar(70, 'Building practice solutions...');
      await sleep(15000);  // 15 seconds
      updateProgressBar(75, 'Polishing content...');
      await sleep(10000);  // 10 seconds
      updateProgressBar(80, 'Almost done...');

      // Wait for API to complete
      const response = await apiPromise;

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to generate course');
      }

      const result = await response.json();
      console.log('API Result:', result);

      // Progress: Finalizing
      console.log('Progress: 85%');
      updateProgressBar(85, 'Finalizing course structure...');
      await sleep(2000);

      console.log('Progress: 95%');
      updateProgressBar(95, 'Preparing files...');
      await sleep(2000);

      // Progress: Complete
      console.log('Progress: 100%');
      updateProgressBar(100, 'Course generated successfully!');
      await sleep(3000);

      // Show success
      console.log('Showing success page...');
      console.log('Result data:', JSON.stringify(result));
      showSuccess(result);

      // Wait a bit before clearing flag to prevent reload
      await sleep(1000);

      // Clear generation flag
      console.log('Clearing generation flag');
      window.isGeneratingCourse = false;

    } catch (error) {
      console.error('Error generating course:', error);
      window.isGeneratingCourse = false;
      alert(`‚ùå Error generating course:\n\n${error.message}\n\nMake sure the API server is running:\npython -m src.intelligent_photocopier.api`);
      // Reset to step 2
      nextStep(2);
    }
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  function updateProgressBar(percent, text) {
    console.log(`[updateProgressBar] Called with ${percent}%, "${text}"`);

    const bar = document.getElementById('progressBar');
    const textElem = document.getElementById('progressText');
    const percentElem = document.getElementById('progressPercent');

    console.log(`[updateProgressBar] Elements found - bar: ${!!bar}, text: ${!!textElem}, percent: ${!!percentElem}`);

    if (bar && textElem && percentElem) {
      bar.style.width = percent + '%';
      textElem.textContent = text;
      percentElem.textContent = percent + '%';
      console.log(`[updateProgressBar] SUCCESS - Bar width: ${bar.style.width}, Text: ${textElem.textContent}`);
    } else {
      console.error('[updateProgressBar] ERROR - Elements not found!');
      console.error('[updateProgressBar] bar:', bar);
      console.error('[updateProgressBar] textElem:', textElem);
      console.error('[updateProgressBar] percentElem:', percentElem);
    }
  }

  function showSuccess(result) {
    console.log('[showSuccess] Function called');
    console.log('[showSuccess] Result:', result);
    console.log('[showSuccess] Current URL:', window.location.href);

    const courseId = result.courseId;
    const title = document.getElementById('courseTitle').value;
    const level = document.getElementById('courseLevel').value;
    const duration = document.getElementById('courseDuration').value;

    document.getElementById('previewTitle').textContent = title;
    document.getElementById('courseLocation').textContent = `Lessons/${courseId}/`;

    const filesCreated = result.filesCreated || [];

    // Store content for immediate preview
    if (result.content) {
      sessionStorage.setItem(`preview_${courseId}`, JSON.stringify(result.content));
    }

    const deploymentNote = result.githubCommitted
      ? `<div style="background: #dbeafe; padding: 1rem; border-radius: 12px; margin-top: 1rem;">
           <p style="color: #1e40af; margin: 0; font-weight: 600;">‚è±Ô∏è Deploying to website...</p>
           <p style="color: #3b82f6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">
             Please wait <span id="countdown">180</span> seconds for Netlify to deploy.
           </p>
           <div style="margin-top: 1rem; background: #f0f9ff; border-radius: 8px; height: 8px; overflow: hidden;">
             <div id="deployProgress" style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: 0%; transition: width 1s linear;"></div>
           </div>
         </div>`
      : '<p style="color: #f59e0b; margin-top: 1rem;"><strong>‚ö†</strong> Files generated but not committed to GitHub.</p>';

    const courseStructure = `
      <p style="margin-bottom: 1rem;"><strong>üìö ${title}</strong></p>
      <p style="color: #718096; margin-bottom: 0.5rem;"><strong>Level:</strong> ${level} | <strong>Duration:</strong> ${duration}</p>
      <p style="color: #718096; margin-bottom: 1rem;"><strong>Course ID:</strong> <code>${courseId}</code></p>
      <hr style="margin: 1rem 0; border: none; border-top: 1px solid #e2e8f0;">
      <p style="font-weight: 600; margin-bottom: 0.5rem; color: #059669;">‚úì ${filesCreated.length} Files Generated:</p>
      <ul style="margin-left: 1.5rem; color: #4a5568; line-height: 1.8;">
        ${filesCreated.map(f => `<li>${f}</li>`).join('')}
      </ul>
      ${deploymentNote}
      <div style="margin-top: 1.5rem; padding: 1rem; background: #d1fae5; border-radius: 12px;">
        <p style="margin: 0; color: #065f46; font-weight: 600;">üéâ ${result.message}</p>
      </div>
      <div style="margin-top: 1.5rem; display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <button onclick="previewCourse('${courseId}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s ease;">
          üëÅÔ∏è Preview Now
        </button>
        <button id="viewCourseBtn" onclick="viewCourse('${courseId}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); transition: all 0.3s ease; white-space: nowrap;">
          üåê <span id="btnText">Deploying...</span>
        </button>
        <button onclick="viewMyCourses()" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; white-space: nowrap;">üìö My Courses</button>
      </div>
    `;

    document.getElementById('courseStructurePreview').innerHTML = courseStructure;

    // Start countdown if GitHub commit was successful
    if (result.githubCommitted) {
      startDeploymentCountdown();
    }

    console.log('About to switch to step 4...');
    console.log('Step 4 element exists:', !!document.getElementById('step4'));
    nextStep(4);
    console.log('Step 4 should now be visible');
  }

  function startDeploymentCountdown() {
    let seconds = 60; // 1 minute
    const countdownElem = document.getElementById('countdown');
    const btnTextElem = document.getElementById('btnText');
    const progressElem = document.getElementById('deployProgress');
    const btnElem = document.getElementById('viewCourseBtn');

    const interval = setInterval(() => {
      seconds--;
      if (countdownElem) countdownElem.textContent = seconds;
      if (progressElem) {
        const progress = ((60 - seconds) / 60) * 100;
        progressElem.style.width = progress + '%';
      }

      if (seconds <= 0) {
        clearInterval(interval);
        // Update button text
        if (btnTextElem) {
          btnTextElem.textContent = 'View Course ‚Üí';
        }
        if (btnElem) {
          btnElem.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          btnElem.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.4)';
        }
      }
    }, 1000);
  }

  function previewCourse(courseId) {
    const content = sessionStorage.getItem('preview_' + courseId);
    if (!content) {
      alert('Preview content not available. Please wait for deployment.');
      return;
    }

    const files = JSON.parse(content);

    // Create preview window
    const previewWindow = window.open('', '_blank', 'width=1200,height=800');
    previewWindow.document.write(
      '<!DOCTYPE html>' +
      '<html>' +
      '<head>' +
        '<title>Preview: ' + courseId + '</title>' +
        '<style>' +
          'body { font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif; max-width: 900px; margin: 0 auto; padding: 2rem; line-height: 1.6; background: #f7fafc; }' +
          'h1, h2, h3 { color: #2d3748; margin-top: 2rem; }' +
          'code { background: #fff; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.9em; border: 1px solid #e2e8f0; }' +
          'pre { background: #2d3748; color: #f7fafc; padding: 1rem; border-radius: 8px; overflow-x: auto; }' +
          'pre code { background: transparent; padding: 0; border: none; }' +
          '.banner { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; text-align: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }' +
          '.file-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }' +
          '.file-tab { padding: 0.6rem 1.2rem; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; background: white; transition: all 0.3s; font-weight: 500; }' +
          '.file-tab:hover { background: #f7fafc; border-color: #667eea; transform: translateY(-2px); }' +
          '.file-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }' +
          '.content-area { display: none; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }' +
          '.content-area.active { display: block; animation: fadeIn 0.3s ease; }' +
          '@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }' +
          'ul, ol { margin-left: 1.5rem; }' +
          'li { margin-bottom: 0.5rem; }' +
          'blockquote { border-left: 4px solid #667eea; padding-left: 1rem; margin-left: 0; color: #4a5568; background: #f7fafc; padding: 1rem; border-radius: 0 8px 8px 0; }' +
        '</style>' +
        '<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"><\/script>' +
      '</head>' +
      '<body>' +
        '<div class="banner">' +
          '<h2 style="margin: 0;">üìö Course Preview: ' + courseId + '</h2>' +
          '<p style="margin: 0.5rem 0 0 0; opacity: 0.9;">‚ö° Instant preview - Deployment in progress...</p>' +
        '</div>' +
        '<div class="file-tabs" id="tabs"></div>' +
        '<div id="content"></div>' +
        '<script>' +
          'var files = ' + JSON.stringify(files) + ';' +
          'var contentDiv = document.getElementById("content");' +
          'var tabsDiv = document.getElementById("tabs");' +
          'Object.keys(files).forEach(function(fileName, index) {' +
            'var tab = document.createElement("button");' +
            'tab.className = "file-tab" + (index === 0 ? " active" : "");' +
            'tab.textContent = fileName;' +
            'tab.onclick = function() { showFile(fileName); };' +
            'tabsDiv.appendChild(tab);' +
            'var contentArea = document.createElement("div");' +
            'contentArea.className = "content-area" + (index === 0 ? " active" : "");' +
            'contentArea.id = "file-" + index;' +
            'contentArea.innerHTML = marked.parse(files[fileName]);' +
            'contentDiv.appendChild(contentArea);' +
          '});' +
          'function showFile(fileName) {' +
            'document.querySelectorAll(".file-tab").forEach(function(t) { t.classList.remove("active"); });' +
            'document.querySelectorAll(".content-area").forEach(function(c) { c.classList.remove("active"); });' +
            'var index = Object.keys(files).indexOf(fileName);' +
            'document.querySelectorAll(".file-tab")[index].classList.add("active");' +
            'document.getElementById("file-" + index).classList.add("active");' +
          '}' +
        '<\/script>' +
      '</body>' +
      '</html>'
    );
  }

  function viewCourse(courseId) {
    console.log('Navigating to course:', courseId);
    window.location.href = `/${courseId}/`;
  }

  function viewMyCourses() {
    // Force reload auth state from localStorage
    accessToken = localStorage.getItem('accessToken');
    const userStr = localStorage.getItem('currentUser');
    if (userStr) {
      currentUser = JSON.parse(userStr);
    } else {
      currentUser = null;
    }

    console.log('My Courses - Auth check:', {
      hasToken: !!accessToken,
      hasUser: !!currentUser,
      user: currentUser
    });

    if (!accessToken || !currentUser) {
      // Show elegant login prompt modal
      showLoginPrompt();
      return;
    }

    // If logged in, show courses modal
    showMyCoursesModal();
  }  function showLoginPrompt() {
    const existingPrompt = document.getElementById('loginPromptModal');
    if (existingPrompt) {
      existingPrompt.remove();
    }

    const modal = document.createElement('div');
    modal.id = 'loginPromptModal';
    modal.className = 'modal';
    modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;';

    modal.innerHTML = `
      <div class="modal-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 3rem; border-radius: 24px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">üîí</div>
        <h2 style="margin: 0 0 1rem 0; color: white; font-size: 1.75rem;">Login Required</h2>
        <p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; margin-bottom: 2rem;">Please login to view your courses and access personalized features.</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button onclick="closeLoginPrompt(); showLogin();" style="padding: 0.875rem 2rem; background: white; color: #667eea; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            Login Now
          </button>
          <button onclick="closeLoginPrompt()" style="padding: 0.875rem 2rem; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: all 0.3s;">
            Cancel
          </button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeLoginPrompt();
      }
    });
  }

  function closeLoginPrompt() {
    const modal = document.getElementById('loginPromptModal');
    if (modal) {
      modal.remove();
    }
  }

  async function showMyCoursesModal() {
    // Double-check authentication before showing modal
    if (!accessToken || !currentUser) {
      console.error('showMyCoursesModal called without authentication');
      showLoginPrompt();
      return;
    }

    // Create modal dynamically
    const existingModal = document.getElementById('myCoursesModal');
    if (existingModal) {
      existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.id = 'myCoursesModal';
    modal.className = 'modal';
    modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;';

    modal.innerHTML = `
      <div class="modal-content" style="background: white; padding: 3rem; border-radius: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <h2 style="margin: 0; color: #1a202c; font-size: 2rem;">üìö My Courses</h2>
          <button onclick="closeMyCoursesModal()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #718096;">&times;</button>
        </div>
        <div id="coursesListContainer" style="min-height: 200px;">
          <div style="text-align: center; padding: 2rem; color: #718096;">
            <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
            <p>Loading your courses...</p>
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeMyCoursesModal();
      }
    });

    // Fetch user's courses
    try {
      const response = await fetch(`${API_BASE}/courses/my`, {
        headers: {
          'Authorization': `Bearer ${accessToken}`
        }
      });

      if (response.ok) {
        const data = await response.json();
        displayCourses(data.courses);
      } else if (response.status === 401) {
        const refreshed = await refreshAccessToken();
        if (refreshed) {
          return showMyCoursesModal();
        }
        document.getElementById('coursesListContainer').innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #e53e3e;">
            <p>Session expired. Please login again.</p>
          </div>
        `;
      } else {
        throw new Error('Failed to load courses');
      }
    } catch (error) {
      console.error('Error loading courses:', error);
      document.getElementById('coursesListContainer').innerHTML = `
        <div style="text-align: center; padding: 2rem; color: #e53e3e;">
          <p>Failed to load courses. Please try again.</p>
        </div>
      `;
    }
  }

  function displayCourses(courses) {
    const container = document.getElementById('coursesListContainer');

    if (!courses || courses.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 3rem; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: 20px;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üéì</div>
          <p style="font-size: 1.25rem; color: #1a202c; font-weight: 600; margin-bottom: 0.5rem;">No courses yet</p>
          <p style="color: #4a5568;">Generate your first course to get started!</p>
        </div>
      `;
      return;
    }

    container.innerHTML = courses.map(course => `
      <div style="background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h3 style="margin: 0 0 0.5rem 0; color: #1a202c; font-size: 1.3rem;">${course.title}</h3>
        <p style="color: #2d3748; margin: 0.5rem 0; font-size: 0.95rem;">${course.description || 'No description'}</p>
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin: 1rem 0;">
          ${course.level ? `<span style="padding: 0.375rem 0.875rem; background: rgba(255,255,255,0.3); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">${course.level}</span>` : ''}
          ${course.duration ? `<span style="padding: 0.375rem 0.875rem; background: rgba(255,255,255,0.3); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">‚è±Ô∏è ${course.duration}</span>` : ''}
          <span style="padding: 0.375rem 0.875rem; background: rgba(255,255,255,0.3); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">üìÖ ${new Date(course.created_at).toLocaleDateString()}</span>
        </div>
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
          ${course.deployed_url ? `<a href="${course.deployed_url}" target="_blank" style="padding: 0.625rem 1.25rem; background: white; color: #667eea; border-radius: 10px; text-decoration: none; font-weight: 600; font-size: 0.9rem; transition: all 0.3s;">View Course ‚Üí</a>` : ''}
          ${course.github_url ? `<a href="${course.github_url}" target="_blank" style="padding: 0.625rem 1.25rem; background: rgba(0,0,0,0.1); color: #1a202c; border-radius: 10px; text-decoration: none; font-weight: 600; font-size: 0.9rem; transition: all 0.3s;">GitHub</a>` : ''}
        </div>
      </div>
    `).join('');
  }

  function closeMyCoursesModal() {
    const modal = document.getElementById('myCoursesModal');
    if (modal) {
      modal.remove();
    }
  }

  function resetBuilder() {
    nextStep(1);
    document.getElementById('courseContent').value = '';
    document.getElementById('courseId').value = '';
    document.getElementById('courseTitle').value = '';
    document.getElementById('courseDescription').value = '';
    document.getElementById('fileInput').value = '';
    document.getElementById('filePreview').style.display = 'none';
    generatedCourseId = '';

    // Reset progress steps
    const steps = document.querySelectorAll('.progress-step');
    steps[0].style.background = '#f0f9ff';
    steps[0].querySelector('span:first-child').textContent = '‚úÖ';
    steps[1].style.background = '#fef3c7';
    steps[1].querySelector('span:first-child').textContent = '‚è≥';
    for (let i = 2; i < steps.length; i++) {
      steps[i].style.background = '#f7fafc';
      steps[i].style.opacity = '0.5';
      steps[i].querySelector('span:first-child').textContent = '‚è∏Ô∏è';
    }
  }
</script>

<div style="background: linear-gradient(135deg, #e0c3fc15 0%, #8ec5fc15 100%); padding: 3rem; border-radius: 32px; margin-bottom: 4rem; box-shadow: 0 8px 30px rgba(0,0,0,0.06);">
  <h2 style="border: none; text-align: center; margin-top: 0;">‚ú® What Makes This Special</h2>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-top: 2rem;">
    <div style="text-align: center; padding: 2rem; background: white; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.06);">
      <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
      <h3 style="margin: 0.5rem 0; font-size: 1.25rem;">Rich Library</h3>
      <p style="color: #718096; margin: 0;">Pre-loaded professional courses ready to use</p>
    </div>
    <div style="text-align: center; padding: 2rem; background: white; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.06);">
      <div style="font-size: 3rem; margin-bottom: 1rem;">üé®</div>
      <h3 style="margin: 0.5rem 0; font-size: 1.25rem;">Custom Content</h3>
      <p style="color: #718096; margin: 0;">Generate courses from your own materials</p>
    </div>
    <div style="text-align: center; padding: 2rem; background: white; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.06);">
      <div style="width: 64px; height: 64px; margin: 0 auto 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 22.5l-.394-1.933a2.25 2.25 0 00-1.423-1.423L12.75 18.75l1.933-.394a2.25 2.25 0 001.423-1.423L16.5 15l.394 1.933a2.25 2.25 0 001.423 1.423l1.933.394-1.933.394a2.25 2.25 0 00-1.423 1.423z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h3 style="margin: 0.5rem 0; font-size: 1.25rem;">AI-Powered</h3>
      <p style="color: #718096; margin: 0;">Leverages GPT-4 for intelligent content</p>
    </div>
  </div>
</div>

<div id="courses" style="scroll-margin-top: 2rem;">
  <h2 style="text-align: center; margin-bottom: 2rem;">üìö Explore Our Courses</h2>

  <div class="course-grid">
{% for course in collections.courses %}
  {% if loop.index <= 3 %}
  <div class="course-card">
    <h3><a href="{{ course.url }}">{% if course.data.courseId %}{{ course.data.courseId }}: {% endif %}{{ course.data.title or 'Untitled Course' }}</a></h3>
    <p style="flex-grow: 1; color: #4a5568; line-height: 1.7;">{{ course.data.description or course.data.excerpt or 'Explore this course and level up your skills...' }}</p>
    <div style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
      {% if course.data.level %}
      <span class="tag">{{ course.data.level }}</span>
      {% endif %}
      {% if course.data.duration %}
      <span class="tag">‚è±Ô∏è {{ course.data.duration }}</span>
      {% endif %}
    </div>
    <a href="{{ course.url }}" class="btn" style="margin-top: auto; text-align: center;">Explore Course ‚Üí</a>
  </div>
  {% endif %}
{% endfor %}
</div>

{% if collections.courses.length > 3 %}
<div style="text-align: center; margin-top: 3rem;">
  <a href="/courses/" class="btn" style="font-size: 1.1rem; padding: 1rem 2.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">View All Courses ‚Üí</a>
</div>
{% endif %}

{% if collections.courses.length == 0 %}
<div style="text-align: center; padding: 4rem; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: 32px; box-shadow: 0 8px 30px rgba(0,0,0,0.08);">
  <div style="font-size: 4rem; margin-bottom: 1rem;">üéì</div>
  <p style="font-size: 1.5rem; color: #1a202c; font-weight: 600; margin-bottom: 1rem;">No courses generated yet</p>
  <p style="color: #4a5568; margin-bottom: 2rem;">Run the Intelligent Photocopier to create your first course!</p>
  <a href="https://github.com/chengxin199/IS601_MidtermProject_Intelligent-Photocopier" class="btn" style="font-size: 1.1rem; padding: 1.25rem 2.5rem;">Get Started on GitHub ‚Üí</a>
</div>
{% endif %}
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: white; padding: 3rem; border-radius: 24px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h2 style="margin: 0; color: #1a202c; font-size: 2rem;">Login</h2>
      <button onclick="closeModal('loginModal')" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #718096;">&times;</button>
    </div>
    <form id="loginForm" onsubmit="handleLogin(event)">
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;">Username or Email</label>
        <input type="text" id="loginUsername" required style="width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;" placeholder="Enter username or email">
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;">Password</label>
        <input type="password" id="loginPassword" required style="width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;" placeholder="Enter password">
      </div>
      <div id="loginError" style="display: none; padding: 0.875rem; background: #fed7d7; color: #c53030; border-radius: 12px; margin-bottom: 1rem;"></div>
      <button type="submit" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: all 0.3s;">
        Login
      </button>
      <p style="text-align: center; margin-top: 1.5rem; color: #718096;">
        Don't have an account? <a href="javascript:void(0)" onclick="closeModal('loginModal'); showRegister();" style="color: #667eea; font-weight: 600;">Sign up</a>
      </p>
    </form>
  </div>
</div>

<!-- Register Modal -->
<div id="registerModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: white; padding: 3rem; border-radius: 24px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h2 style="margin: 0; color: #1a202c; font-size: 2rem;">Sign Up</h2>
      <button onclick="closeModal('registerModal')" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #718096;">&times;</button>
    </div>
    <form id="registerForm" onsubmit="handleRegister(event)">
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;">Username</label>
        <input type="text" id="registerUsername" required minlength="3" style="width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;" placeholder="Choose a username">
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;">Email</label>
        <input type="email" id="registerEmail" required style="width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;" placeholder="Your email address">
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;">Full Name (Optional)</label>
        <input type="text" id="registerFullName" style="width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;" placeholder="Your full name">
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;">Password</label>
        <input type="password" id="registerPassword" required minlength="6" style="width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;" placeholder="At least 6 characters">
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;">Confirm Password</label>
        <input type="password" id="registerConfirmPassword" required minlength="6" style="width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;" placeholder="Confirm your password">
      </div>
      <div id="registerError" style="display: none; padding: 0.875rem; background: #fed7d7; color: #c53030; border-radius: 12px; margin-bottom: 1rem;"></div>
      <button type="submit" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: all 0.3s;">
        Sign Up
      </button>
      <p style="text-align: center; margin-top: 1.5rem; color: #718096;">
        Already have an account? <a href="javascript:void(0)" onclick="closeModal('registerModal'); showLogin();" style="color: #667eea; font-weight: 600;">Login</a>
      </p>
    </form>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: white; padding: 3rem; border-radius: 24px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h2 style="margin: 0; color: #1a202c; font-size: 2rem;">Profile Settings</h2>
      <button onclick="closeModal('profileModal')" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #718096;">&times;</button>
    </div>
    <form id="profileForm" onsubmit="handleUpdateProfile(event)">
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;">Username</label>
        <input type="text" id="profileUsername" readonly style="width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; background: #f7fafc; color: #718096;">
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;">Email</label>
        <input type="email" id="profileEmail" readonly style="width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; background: #f7fafc; color: #718096;">
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;">Full Name</label>
        <input type="text" id="profileFullName" style="width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;" placeholder="Your full name">
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;">Bio</label>
        <textarea id="profileBio" rows="3" style="width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; resize: vertical;" placeholder="Tell us about yourself..."></textarea>
      </div>
      <div id="profileError" style="display: none; padding: 0.875rem; background: #fed7d7; color: #c53030; border-radius: 12px; margin-bottom: 1rem;"></div>
      <div id="profileSuccess" style="display: none; padding: 0.875rem; background: #c6f6d5; color: #2f855a; border-radius: 12px; margin-bottom: 1rem;"></div>
      <button type="submit" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: all 0.3s;">
        Save Changes
      </button>
    </form>
  </div>
</div>

<script>
// API Configuration
const API_BASE = 'https://intelligent-photocopier.onrender.com/api';

// Auth State Management
let currentUser = null;
let accessToken = null;
let refreshToken = null;

// Initialize auth state on page load
document.addEventListener('DOMContentLoaded', function() {
  loadAuthState();
  checkAuth();
});

function loadAuthState() {
  accessToken = localStorage.getItem('accessToken');
  refreshToken = localStorage.getItem('refreshToken');
  const userStr = localStorage.getItem('currentUser');
  if (userStr) {
    currentUser = JSON.parse(userStr);
  }
}

function saveAuthState(user, access, refresh) {
  currentUser = user;
  accessToken = access;
  refreshToken = refresh;
  localStorage.setItem('currentUser', JSON.stringify(user));
  localStorage.setItem('accessToken', access);
  localStorage.setItem('refreshToken', refresh);
}

function clearAuthState() {
  currentUser = null;
  accessToken = null;
  refreshToken = null;
  localStorage.removeItem('currentUser');
  localStorage.removeItem('accessToken');
  localStorage.removeItem('refreshToken');
}

async function checkAuth() {
  if (!accessToken) {
    showLoggedOut();
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/auth/me`, {
      headers: {
        'Authorization': `Bearer ${accessToken}`
      }
    });

    if (response.ok) {
      const data = await response.json();
      currentUser = data.user;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      showLoggedIn();
    } else if (response.status === 401) {
      // Token expired, try to refresh
      await refreshAccessToken();
    } else {
      showLoggedOut();
    }
  } catch (error) {
    console.error('Auth check failed:', error);
    showLoggedOut();
  }
}

async function refreshAccessToken() {
  if (!refreshToken) {
    showLoggedOut();
    return false;
  }

  try {
    const response = await fetch(`${API_BASE}/auth/refresh`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({refresh_token: refreshToken})
    });

    if (response.ok) {
      const data = await response.json();
      accessToken = data.access_token;
      localStorage.setItem('accessToken', accessToken);
      return true;
    } else {
      clearAuthState();
      showLoggedOut();
      return false;
    }
  } catch (error) {
    console.error('Token refresh failed:', error);
    clearAuthState();
    showLoggedOut();
    return false;
  }
}

function showLoggedIn() {
  document.getElementById('logged-out-buttons').style.display = 'none';
  document.getElementById('logged-in-buttons').style.display = 'flex';
  if (currentUser) {
    document.getElementById('username-display').textContent = `üëã ${currentUser.username}`;
  }
}

function showLoggedOut() {
  document.getElementById('logged-out-buttons').style.display = 'flex';
  document.getElementById('logged-in-buttons').style.display = 'none';
}

// Modal Functions
function showLogin() {
  document.getElementById('loginModal').style.display = 'flex';
  document.getElementById('loginError').style.display = 'none';
}

function showRegister() {
  document.getElementById('registerModal').style.display = 'flex';
  document.getElementById('registerError').style.display = 'none';
}

function showProfile() {
  if (!currentUser) return;

  document.getElementById('profileModal').style.display = 'flex';
  document.getElementById('profileUsername').value = currentUser.username || '';
  document.getElementById('profileEmail').value = currentUser.email || '';
  document.getElementById('profileFullName').value = currentUser.full_name || '';
  document.getElementById('profileBio').value = currentUser.bio || '';
  document.getElementById('profileError').style.display = 'none';
  document.getElementById('profileSuccess').style.display = 'none';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

// Click outside modal to close
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', function(e) {
    if (e.target === this) {
      closeModal(this.id);
    }
  });
});

// Auth Handlers
async function handleLogin(event) {
  event.preventDefault();

  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  const errorDiv = document.getElementById('loginError');

  try {
    const response = await fetch(`${API_BASE}/auth/login`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username, password})
    });

    const data = await response.json();

    if (response.ok) {
      saveAuthState(data.user, data.access_token, data.refresh_token);
      showLoggedIn();
      closeModal('loginModal');
      showSuccess('Welcome back, ' + data.user.username + '!');
    } else {
      errorDiv.textContent = data.error || 'Login failed';
      errorDiv.style.display = 'block';
    }
  } catch (error) {
    errorDiv.textContent = 'Network error. Please try again.';
    errorDiv.style.display = 'block';
  }
}

async function handleRegister(event) {
  event.preventDefault();

  const username = document.getElementById('registerUsername').value.trim();
  const email = document.getElementById('registerEmail').value.trim();
  const fullName = document.getElementById('registerFullName').value.trim();
  const password = document.getElementById('registerPassword').value;
  const confirmPassword = document.getElementById('registerConfirmPassword').value;
  const errorDiv = document.getElementById('registerError');

  if (password !== confirmPassword) {
    errorDiv.textContent = 'Passwords do not match';
    errorDiv.style.display = 'block';
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/auth/register`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username, email, password, full_name: fullName})
    });

    const data = await response.json();

    if (response.ok) {
      saveAuthState(data.user, data.access_token, data.refresh_token);
      showLoggedIn();
      closeModal('registerModal');
      showSuccess('Welcome, ' + data.user.username + '! Your account has been created.');
    } else {
      errorDiv.textContent = data.error || 'Registration failed';
      errorDiv.style.display = 'block';
    }
  } catch (error) {
    errorDiv.textContent = 'Network error. Please try again.';
    errorDiv.style.display = 'block';
  }
}

async function handleUpdateProfile(event) {
  event.preventDefault();

  const fullName = document.getElementById('profileFullName').value.trim();
  const bio = document.getElementById('profileBio').value.trim();
  const errorDiv = document.getElementById('profileError');
  const successDiv = document.getElementById('profileSuccess');

  errorDiv.style.display = 'none';
  successDiv.style.display = 'none';

  try {
    const response = await fetch(`${API_BASE}/profile`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${accessToken}`
      },
      body: JSON.stringify({full_name: fullName, bio})
    });

    const data = await response.json();

    if (response.ok) {
      currentUser = data.user;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      successDiv.textContent = 'Profile updated successfully!';
      successDiv.style.display = 'block';
    } else if (response.status === 401) {
      const refreshed = await refreshAccessToken();
      if (refreshed) {
        return handleUpdateProfile(event);
      }
      errorDiv.textContent = 'Session expired. Please login again.';
      errorDiv.style.display = 'block';
    } else {
      errorDiv.textContent = data.error || 'Update failed';
      errorDiv.style.display = 'block';
    }
  } catch (error) {
    errorDiv.textContent = 'Network error. Please try again.';
    errorDiv.style.display = 'block';
  }
}

function logout() {
  clearAuthState();
  showLoggedOut();
  showSuccess('You have been logged out successfully.');
}

function showSuccess(message) {
  // Create temporary success notification
  const notification = document.createElement('div');
  notification.style.cssText = 'position: fixed; top: 2rem; right: 2rem; background: #c6f6d5; color: #2f855a; padding: 1rem 2rem; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); z-index: 2000; font-weight: 600;';
  notification.textContent = message;
  document.body.appendChild(notification);

  setTimeout(() => {
    notification.remove();
  }, 3000);
}
</script>

<!-- Version Footer -->
<footer style="text-align: center; padding: 2rem; margin-top: 4rem; border-top: 1px solid #e2e8f0;">
  <p style="color: #718096; font-size: 0.875rem; margin: 0;">
    Intelligent Photocopier <span style="font-weight: 600; color: #4a5568;">v1.0.5</span>
  </p>
  <p style="color: #a0aec0; font-size: 0.75rem; margin: 0.5rem 0 0 0;">
    Last updated: December 06, 2025
  </p>
</footer>
